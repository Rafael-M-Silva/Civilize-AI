// Gerador automÃ¡tico de cursos baseado em diÃ¡rios oficiais simplificados

import { Course, Module, Quiz, Question } from './types';
import { DiarioOficial, DiarioExcerpt } from './queridoDiarioMockData';

export interface GeneratedCourse {
  course: Course;
  metadata: {
    sourceType: 'diario_oficial';
    sourceDiarioId: string;
    generatedAt: Date;
    autoGenerated: boolean;
    reviewStatus: 'pending' | 'approved' | 'rejected';
  };
}

/**
 * Gera um curso completo baseado em um diÃ¡rio oficial simplificado
 */
export function generateCourseFromDiario(
  diario: DiarioOficial,
  excerpts: DiarioExcerpt[]
): GeneratedCourse {
  const courseId = `course-auto-${Date.now()}`;
  
  // Determinar tema principal
  const mainTheme = diario.themes[0] || 'Cidadania';
  
  // Gerar mÃ³dulos (um para cada excerto)
  const modules: Module[] = excerpts.map((excerpt, index) => {
    return {
      id: `${courseId}-mod-${index + 1}`,
      title: `${excerpt.theme}: ${excerpt.subtheme}`,
      description: `Aprenda sobre ${excerpt.subtheme} de forma simples e prÃ¡tica`,
      duration: '15 min',
      videoUrl: `https://www.youtube.com/watch?v=dQw4w9WgXcQ`, // Placeholder
      content: excerpt.simplified_text,
      completed: false,
      unlocked: index === 0 // Apenas o primeiro mÃ³dulo desbloqueado
    };
  });

  // Gerar quizzes (um para cada mÃ³dulo)
  const quizzes: Quiz[] = modules.map((module, index) => {
    const excerpt = excerpts[index];
    return generateQuizForExcerpt(module.id, excerpt);
  });

  // Criar o curso
  const course: Course = {
    id: courseId,
    title: `${mainTheme}: ${diario.territory_name}`,
    description: `Entenda as novas leis e regulamentaÃ§Ãµes de ${diario.territory_name} sobre ${mainTheme.toLowerCase()} de forma simples e acessÃ­vel.`,
    thumbnail: getThemeImage(mainTheme),
    category: mainTheme,
    level: 'beginner',
    totalModules: modules.length,
    duration: `${modules.length * 15} min`,
    xpReward: modules.length * 50,
    modules,
    quizzes,
    tags: [...diario.themes, ...diario.subthemes, diario.state_code],
    instructor: 'IA Civilize',
    rating: 0,
    enrolledCount: 0,
    isLocked: true,
    price: 0 // GrÃ¡tis pois Ã© auto-gerado de fonte pÃºblica
  };

  return {
    course,
    metadata: {
      sourceType: 'diario_oficial',
      sourceDiarioId: diario.id,
      generatedAt: new Date(),
      autoGenerated: true,
      reviewStatus: 'pending'
    }
  };
}

/**
 * Gera um quiz baseado em um excerto simplificado
 */
function generateQuizForExcerpt(moduleId: string, excerpt: DiarioExcerpt): Quiz {
  const quizId = `quiz-${moduleId}`;
  
  // Gerar perguntas baseadas no conteÃºdo
  const questions: Question[] = generateQuestionsFromExcerpt(excerpt);

  return {
    id: quizId,
    moduleId,
    title: `Quiz: ${excerpt.theme}`,
    description: `Teste seus conhecimentos sobre ${excerpt.subtheme}`,
    passingScore: 75,
    questions,
    timeLimit: 300, // 5 minutos
    xpReward: 50
  };
}

/**
 * Gera perguntas de mÃºltipla escolha baseadas no excerto
 */
function generateQuestionsFromExcerpt(excerpt: DiarioExcerpt): Question[] {
  const questions: Question[] = [];

  // QuestÃ£o 1: Tema principal
  questions.push({
    id: `q1-${excerpt.id}`,
    question: `Sobre qual tema principal trata este conteÃºdo?`,
    options: [
      excerpt.theme,
      getRandomTheme(excerpt.theme),
      getRandomTheme(excerpt.theme),
      getRandomTheme(excerpt.theme)
    ],
    correctAnswer: 0,
    explanation: `O tema principal Ã© ${excerpt.theme}, abordando especificamente ${excerpt.subtheme}.`
  });

  // QuestÃ£o 2: PÃºblico-alvo
  questions.push({
    id: `q2-${excerpt.id}`,
    question: `Para quem essa informaÃ§Ã£o Ã© mais relevante?`,
    options: [
      excerpt.target_audience,
      'Apenas profissionais da Ã¡rea jurÃ­dica',
      'Somente empresÃ¡rios',
      'Apenas servidores pÃºblicos'
    ],
    correctAnswer: 0,
    explanation: `Esta informaÃ§Ã£o foi simplificada para ${excerpt.target_audience}, tornando-a acessÃ­vel para todos.`
  });

  // QuestÃ£o 3: Palavras-chave
  const keyword = excerpt.keywords[0] || 'cidadania';
  questions.push({
    id: `q3-${excerpt.id}`,
    question: `Qual conceito Ã© fundamental para entender este conteÃºdo?`,
    options: [
      keyword.charAt(0).toUpperCase() + keyword.slice(1),
      'Processo judicial',
      'TributaÃ§Ã£o municipal',
      'LicitaÃ§Ã£o pÃºblica'
    ],
    correctAnswer: 0,
    explanation: `${keyword.charAt(0).toUpperCase() + keyword.slice(1)} Ã© um dos conceitos-chave para compreender este assunto.`
  });

  // QuestÃ£o 4: AplicaÃ§Ã£o prÃ¡tica
  questions.push({
    id: `q4-${excerpt.id}`,
    question: `Qual a melhor forma de aplicar esse conhecimento no dia a dia?`,
    options: [
      generatePracticalApplication(excerpt.theme),
      'Guardar a informaÃ§Ã£o sem usar',
      'Compartilhar apenas com advogados',
      'Ignorar completamente'
    ],
    correctAnswer: 0,
    explanation: `O conhecimento sobre ${excerpt.theme} deve ser aplicado ativamente no seu cotidiano para exercer melhor sua cidadania.`
  });

  return questions;
}

/**
 * Gera uma aplicaÃ§Ã£o prÃ¡tica baseada no tema
 */
function generatePracticalApplication(theme: string): string {
  const applications: { [key: string]: string } = {
    'EducaÃ§Ã£o': 'Participar ativamente das decisÃµes sobre educaÃ§Ã£o na sua comunidade',
    'SaÃºde': 'Conhecer seus direitos ao usar o sistema de saÃºde pÃºblico',
    'Meio Ambiente': 'Aplicar as prÃ¡ticas de sustentabilidade no dia a dia',
    'Transporte': 'Usar o transporte pÃºblico de forma consciente e conhecer seus direitos',
    'Economia': 'Planejar melhor suas finanÃ§as pessoais',
    'Trabalho': 'Conhecer seus direitos trabalhistas e fazer valer',
    'SeguranÃ§a': 'Participar de iniciativas de seguranÃ§a comunitÃ¡ria',
    'Cultura': 'Valorizar e preservar o patrimÃ´nio cultural local'
  };

  return applications[theme] || 'Exercer ativamente sua cidadania no dia a dia';
}

/**
 * Retorna um tema aleatÃ³rio diferente do fornecido (para distratores)
 */
function getRandomTheme(exclude: string): string {
  const themes = ['EducaÃ§Ã£o', 'SaÃºde', 'Meio Ambiente', 'Transporte', 'Economia', 'Trabalho', 'SeguranÃ§a', 'Cultura'];
  const filtered = themes.filter(t => t !== exclude);
  return filtered[Math.floor(Math.random() * filtered.length)];
}

/**
 * Retorna uma imagem apropriada para o tema
 */
function getThemeImage(theme: string): string {
  const images: { [key: string]: string } = {
    'EducaÃ§Ã£o': 'https://images.unsplash.com/photo-1503676260728-1c00da094a0b?w=800',
    'SaÃºde': 'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=800',
    'Meio Ambiente': 'https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?w=800',
    'Transporte': 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=800',
    'Economia': 'https://images.unsplash.com/photo-1579621970563-ebec7560ff3e?w=800',
    'Trabalho': 'https://images.unsplash.com/photo-1521737711867-e3b97375f902?w=800',
    'SeguranÃ§a': 'https://images.unsplash.com/photo-1582139329536-e7284fece509?w=800',
    'Cultura': 'https://images.unsplash.com/photo-1514320291840-2e0a9bf2a9ae?w=800'
  };

  return images[theme] || 'https://images.unsplash.com/photo-1456513080510-7bf3a84b82f8?w=800';
}

/**
 * Gera um artigo educativo baseado no excerto
 */
export function generateArticleFromExcerpt(excerpt: DiarioExcerpt): {
  title: string;
  content: string;
  readTime: string;
  tags: string[];
} {
  return {
    title: `Entenda: ${excerpt.subtheme}`,
    content: `
# ${excerpt.subtheme}

## ðŸ“‹ O que diz a lei original:

${excerpt.original_text}

---

## ðŸ’¡ TraduÃ§Ã£o simples:

${excerpt.simplified_text}

---

## ðŸŽ¯ Por que isso Ã© importante?

Este conhecimento faz parte dos seus direitos como cidadÃ£o. Quando vocÃª entende as leis da sua cidade, pode:

âœ… Participar melhor das decisÃµes pÃºblicas
âœ… Cobrar seus direitos
âœ… Cumprir seus deveres de forma consciente
âœ… Contribuir para uma sociedade mais justa

---

## ðŸ“š Quer saber mais?

Continue estudando outros mÃ³dulos sobre ${excerpt.theme} e torne-se um cidadÃ£o cada vez mais informado!

---

**Fonte:** DiÃ¡rio Oficial processado e simplificado por IA
**NÃ­vel de complexidade:** ${excerpt.complexity_level === 'easy' ? 'FÃ¡cil' : excerpt.complexity_level === 'medium' ? 'MÃ©dio' : 'AvanÃ§ado'}
    `,
    readTime: '5 min',
    tags: excerpt.keywords
  };
}

/**
 * EstatÃ­sticas de geraÃ§Ã£o de cursos
 */
export interface CourseGenerationStats {
  totalGenerated: number;
  pending: number;
  approved: number;
  rejected: number;
  avgModulesPerCourse: number;
  avgQuestionsPerQuiz: number;
  totalStudents: number;
  avgCompletionRate: number;
}

export function getCourseGenerationStats(courses: GeneratedCourse[]): CourseGenerationStats {
  const pending = courses.filter(c => c.metadata.reviewStatus === 'pending').length;
  const approved = courses.filter(c => c.metadata.reviewStatus === 'approved').length;
  const rejected = courses.filter(c => c.metadata.reviewStatus === 'rejected').length;

  const avgModulesPerCourse = courses.reduce((sum, c) => sum + c.course.totalModules, 0) / courses.length || 0;
  const avgQuestionsPerQuiz = courses.reduce((sum, c) => {
    const totalQuestions = c.course.quizzes.reduce((qSum, quiz) => qSum + quiz.questions.length, 0);
    return sum + (totalQuestions / c.course.quizzes.length || 0);
  }, 0) / courses.length || 0;

  return {
    totalGenerated: courses.length,
    pending,
    approved,
    rejected,
    avgModulesPerCourse: Math.round(avgModulesPerCourse * 10) / 10,
    avgQuestionsPerQuiz: Math.round(avgQuestionsPerQuiz * 10) / 10,
    totalStudents: courses.reduce((sum, c) => sum + c.course.enrolledCount, 0),
    avgCompletionRate: 0.73 // Mock: 73%
  };
}
